<!DOCTYPE html>
<html lang="en" data-theme=""><head>
    <title> Celia García Márquez | Virtualización con Libvirt </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.80.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Tarea de virtualización">
    
    <link rel="stylesheet"
          href="https://www.celiagm.es/css/style.min.93ab6bdd416e6acc85a43e3a7629dda51ac58cbb8d193f5e62dc5d448bc2b385.css"
          integrity="sha256-k6tr3UFuasyFpD46dindpRrFjLuNGT9eYtxdRIvCs4U="
          crossorigin="anonymous"
          type="text/css">
    
    <link rel="stylesheet"
        href="https://www.celiagm.es/css/markupHighlight.min.4ac4c94828876abc926f5563ef81e319b441b25cad2c96842d2b87fd204a0de6.css"
        integrity="sha256-SsTJSCiHarySb1Vj74HjGbRBslytLJaELSuH/SBKDeY="
        crossorigin="anonymous"
        type="text/css">
    
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="https://www.celiagm.es/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://www.celiagm.es/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.celiagm.es/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.celiagm.es/favicons/favicon-16x16.png">

    <link rel="canonical" href="https://www.celiagm.es/post/virtualizacion/">

    
    
    
    
    <script type="text/javascript"
            src="https://www.celiagm.es/js/anatole-header.min.d8599ee07b7d3f11bafbac30657ccc591e8d7fd36a9f580cd4c09e24e0e4a971.js"
            integrity="sha256-2Fme4Ht9PxG6&#43;6wwZXzMWR6Nf9Nqn1gM1MCeJODkqXE="
            crossorigin="anonymous"></script>


    
        
        
        <script type="text/javascript"
                src="https://www.celiagm.es/js/anatole-theme-switcher.min.e289e9ebb2a4e7a7f895859c8a2b0da2de1ec73f22cea58d8475aa0597023837.js"
                integrity="sha256-4onp67Kk56f4lYWciisNot4exz8izqWNhHWqBZcCODc="
                crossorigin="anonymous"></script>
    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.celiagm.es/images/avatar_red.jpg"/>

<meta name="twitter:title" content="Virtualización con Libvirt"/>
<meta name="twitter:description" content="Tarea de virtualización"/>


    

</head>
<body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="https://www.celiagm.es/images/avatar_red.jpg" alt="profile picture">
            <h3 title=""><a href="/">Un bit de información cada día</a></h3>
            <div class="description">
                <p>Blog sobre informática</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="https://www.linkedin.com/in/cgmarquez/" rel="me" aria-label="Linkedin">
                    <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/CeliaGMqrz" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="mailto:cg.marquez95@gmail.com" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; Celia García Márquez  2020-2021 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Inicio</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">Sobre mí</a></li>
        
        
        
            <li class="theme-switch-item">
                <a class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post  animated fadeInDown ">
        <div class="post-content">
            
            <img class="post-thumbnail" src="https://www.celiagm.es/images/kvm/kvm.png" alt="Thumbnail image">
            
            <div class="post-title">
                <h3>Virtualización con Libvirt</h3>
                
                    <div class="info">
                        <em class="fas fa-calendar-day"></em>
                        <span class="date"> Thu, Mar 25, 2021 
                                           </span>
                        <em class="fas fa-stopwatch"></em>
                        <span class="reading-time">14-minute read</span>
                    </div>
                
            </div>

            <p>En este post se va a llevar a cabo una práctica para manejar <strong>libvirt</strong>. Saber gestionar un <strong>sistema de virtualización a bajo nivel</strong>.</p>
<p>Para <strong>conceptos previos</strong> puedes acceder a este <a href="https://www.celiagm.es/post/migracion_app_mv/">post</a></p>
<p><strong>Tarea:</strong></p>
<blockquote>
<ol>
<li>Crea con <code>virt-install</code> una imagen de Debian Buster con formato qcow2 y un tamaño máximo de 3GiB. Esta imagen se denominará <code>buster-base.qcow2</code>. El sistema de ficheros del sistema instalado en esta imagen será XFS. La imagen debe estar configurada para poder usar hasta dos interfaces de red por dhcp. El usuario <code>debian</code> con contraseña <code>debian</code> puede utilizar sudo sin contraseña.</li>
</ol>
</blockquote>
<h3 id="crear-redes">Crear redes</h3>
<p>Primero tenemos que crear las redes que necesitamos, en este caso usaremos la default que es <strong>&lsquo;virbr0&rsquo;</strong> y una nueva que vamos a crear <strong>&lsquo;virbr2&rsquo;</strong>.</p>
<p>La <strong>red default</strong> tiene estas caracteristicas:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;4a90cfb3-6969-40c7-99df-d2440cca4d1b&lt;/uuid&gt;
  &lt;forward <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;nat&#39;</span>/&gt;
  &lt;bridge <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;virbr0&#39;</span> <span class="nv">stp</span><span class="o">=</span><span class="s1">&#39;on&#39;</span> <span class="nv">delay</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
  &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;52:54:00:b0:ec:fd&#39;</span>/&gt;
  &lt;ip <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;192.168.122.1&#39;</span> <span class="nv">netmask</span><span class="o">=</span><span class="s1">&#39;255.255.255.0&#39;</span>&gt;
    &lt;dhcp&gt;
      &lt;range <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;192.168.122.2&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;192.168.122.254&#39;</span>/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;

</code></pre></div><p>Actualmente tenemos <strong>dos redes</strong>, una es la que está <strong>por defecto</strong> y la otra es una que ha creado vagrant llamada <em>virbr1</em> (esta no la vamos a usar), por lo que vamos a crear la <strong>virbr2</strong></p>
<h4 id="crear-virbr2">Crear virbr2</h4>
<p>Creamos la red <strong><code>virbr2</code></strong>, dándole un direccionamiento <strong><code>192.168.200.0/24</code></strong> en modo <strong>NAT</strong>.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">nano red2.xml
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;network&gt;
  &lt;name&gt;red2&lt;/name&gt;
  &lt;forward <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;nat&#39;</span>&gt;
    &lt;nat&gt;
      &lt;port <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;1024&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;65535&#39;</span>/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;virbr2&#39;</span> <span class="nv">stp</span><span class="o">=</span><span class="s1">&#39;on&#39;</span> <span class="nv">delay</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
  &lt;ip <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;192.168.200.1&#39;</span> <span class="nv">netmask</span><span class="o">=</span><span class="s1">&#39;255.255.255.0&#39;</span>&gt;
    &lt;dhcp&gt;
      &lt;range <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;192.168.200.2&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;192.168.200.254&#39;</span>/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;

</code></pre></div><p>Definimos la nueva red <strong><code>virbr2</code></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu/networks# virsh net-define red2.xml
Network red2 defined from red2.xml
</code></pre></div><h4 id="listar-las-redes">Listar las redes</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu/networks# virsh net-list --all
 Name              State      Autostart   Persistent
------------------------------------------------------
 default           inactive   no          yes
 red2              active     no          no
 vagrant-libvirt   inactive   no          yes

</code></pre></div><p>Iniciamos las redes oportunas, las marcamos como <strong>autostart</strong> para que se inicien automáticamente.</p>
<p>Listamos las redes y comprobamos que estan activas</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu/networks# virsh net-list --all
 Name              State      Autostart   Persistent
------------------------------------------------------
 default           active     yes         yes
 red2              active     yes         yes
 vagrant-libvirt   inactive   no          yes
</code></pre></div><h3 id="crear-mv-con-la-imagen-qcow2">Crear mv con la imagen qcow2</h3>
<p>Una vez creadas las redes y activadas vamos a crear la <strong>mv</strong> con la imagen <strong>qcow2</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">virt-install --connect qemu:///system --name buster-base --cdrom ~/isos/debian-10.8.0-amd64-netinst.iso --disk <span class="nv">size</span><span class="o">=</span><span class="m">3</span> --network <span class="nv">bridge</span><span class="o">=</span>virbr0 --network <span class="nv">bridge</span><span class="o">=</span>virbr2 --memory <span class="m">1024</span> --vcpus <span class="m">1</span>
</code></pre></div><p>Hacemos la <strong>instalación</strong>, teniendo en cuenta el sistema de archivos con formato <strong>XFS</strong>. No me voy a demorar con la instalación y suponemos que sabemos hacerlo. Una vez iniciado el sistema comprobamos los discos del sistema.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@debian-kvm:~$ lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
sr0
vda
└─vda1 xfs          30a9cfb1-0b31-4368-8b7a-c6779804e450      2G    35% /

</code></pre></div><p>Cuando se haya finalizado la instalación vamos a descargar <strong>sudo</strong>, ya que necesitaremos que el usuario debian en este caso tenga <strong>privilegios</strong> de administrador.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">su -
apt install sudo
adduser debian sudo
nano /etc/sudoers
</code></pre></div><p>Añadimos al usuario <strong>debian</strong> a <strong>sudoers</strong> de forma que pueda usar <em>sudo sin contraseña</em>.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># User privilege specification</span>
root    <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> ALL
debian <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> ALL
<span class="c1"># Allow members of group sudo to execute any command</span>
%sudo   <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> ALL
%debian <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> ALL
debian <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD:ALL
</code></pre></div><p>Comprobamos que se ha creado el archivo <strong><code>buster-base.xml</code></strong> que contiene la informacion de la máquina que hemos creado.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">celiagm@debian:/etc/libvirt/qemu$ sudo cat buster-base.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit buster-base
or other application using the libvirt API.
--&gt;

&lt;domain <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;kvm&#39;</span>&gt;
  &lt;name&gt;buster-base&lt;/name&gt;
  &lt;uuid&gt;01dd42ef-072b-4a96-9108-e62a19260b2e&lt;/uuid&gt;
  &lt;metadata&gt;
    &lt;libosinfo:libosinfo xmlns:libosinfo<span class="o">=</span><span class="s2">&#34;http://libosinfo.org/xmlns/libvirt/domain/1.0&#34;</span>&gt;
      &lt;libosinfo:os <span class="nv">id</span><span class="o">=</span><span class="s2">&#34;http://debian.org/debian/10&#34;</span>/&gt;
    &lt;/libosinfo:libosinfo&gt;
  &lt;/metadata&gt;
  &lt;memory <span class="nv">unit</span><span class="o">=</span><span class="s1">&#39;KiB&#39;</span>&gt;1048576&lt;/memory&gt;
  &lt;currentMemory <span class="nv">unit</span><span class="o">=</span><span class="s1">&#39;KiB&#39;</span>&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu <span class="nv">placement</span><span class="o">=</span><span class="s1">&#39;static&#39;</span>&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;<span class="nb">type</span> <span class="nv">arch</span><span class="o">=</span><span class="s1">&#39;x86_64&#39;</span> <span class="nv">machine</span><span class="o">=</span><span class="s1">&#39;pc-q35-3.1&#39;</span>&gt;hvm&lt;/type&gt;
    &lt;boot <span class="nv">dev</span><span class="o">=</span><span class="s1">&#39;hd&#39;</span>/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;vmport <span class="nv">state</span><span class="o">=</span><span class="s1">&#39;off&#39;</span>/&gt;
  &lt;/features&gt;
  &lt;cpu <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;host-model&#39;</span> <span class="nv">check</span><span class="o">=</span><span class="s1">&#39;partial&#39;</span>&gt;
    &lt;model <span class="nv">fallback</span><span class="o">=</span><span class="s1">&#39;allow&#39;</span>/&gt;
  &lt;/cpu&gt;
  &lt;clock <span class="nv">offset</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span>&gt;
    &lt;timer <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;rtc&#39;</span> <span class="nv">tickpolicy</span><span class="o">=</span><span class="s1">&#39;catchup&#39;</span>/&gt;
    &lt;timer <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pit&#39;</span> <span class="nv">tickpolicy</span><span class="o">=</span><span class="s1">&#39;delay&#39;</span>/&gt;
    &lt;timer <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;hpet&#39;</span> <span class="nv">present</span><span class="o">=</span><span class="s1">&#39;no&#39;</span>/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem <span class="nv">enabled</span><span class="o">=</span><span class="s1">&#39;no&#39;</span>/&gt;
    &lt;suspend-to-disk <span class="nv">enabled</span><span class="o">=</span><span class="s1">&#39;no&#39;</span>/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
    &lt;disk <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span> <span class="nv">device</span><span class="o">=</span><span class="s1">&#39;disk&#39;</span>&gt;
      &lt;driver <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;qcow2&#39;</span>/&gt;
      &lt;<span class="nb">source</span> <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;/var/lib/libvirt/images/buster-base.qcow2&#39;</span>/&gt;
      &lt;target <span class="nv">dev</span><span class="o">=</span><span class="s1">&#39;vda&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x05&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/disk&gt;
    &lt;disk <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span> <span class="nv">device</span><span class="o">=</span><span class="s1">&#39;cdrom&#39;</span>&gt;
      &lt;driver <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span>/&gt;
      &lt;target <span class="nv">dev</span><span class="o">=</span><span class="s1">&#39;sda&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;sata&#39;</span>/&gt;
      &lt;readonly/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;drive&#39;</span> <span class="nv">controller</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">target</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">unit</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
    &lt;/disk&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;qemu-xhci&#39;</span> <span class="nv">ports</span><span class="o">=</span><span class="s1">&#39;15&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x03&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;sata&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x1f&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x2&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root&#39;</span>/&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio-serial&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x04&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x10&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span> <span class="nv">multifunction</span><span class="o">=</span><span class="s1">&#39;on&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;2&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;2&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x11&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x1&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;3&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;3&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x12&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x2&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;4&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;4&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x13&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x3&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;5&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;5&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x14&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x4&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;6&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;6&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x15&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x5&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;7&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;7&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x16&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x6&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;8&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;8&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x17&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x7&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;interface <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;bridge&#39;</span>&gt;
      &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;52:54:00:e4:0c:13&#39;</span>/&gt;
      &lt;<span class="nb">source</span> <span class="nv">bridge</span><span class="o">=</span><span class="s1">&#39;virbr0&#39;</span>/&gt;
      &lt;model <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x01&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/interface&gt;
    &lt;interface <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;bridge&#39;</span>&gt;
      &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;52:54:00:d8:83:43&#39;</span>/&gt;
      &lt;<span class="nb">source</span> <span class="nv">bridge</span><span class="o">=</span><span class="s1">&#39;virbr2&#39;</span>/&gt;
      &lt;model <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/interface&gt;
    &lt;serial <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pty&#39;</span>&gt;
      &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;isa-serial&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>&gt;
        &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;isa-serial&#39;</span>/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pty&#39;</span>&gt;
      &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;serial&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
    &lt;/console&gt;
    &lt;channel <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;unix&#39;</span>&gt;
      &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span> <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;org.qemu.guest_agent.0&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio-serial&#39;</span> <span class="nv">controller</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>/&gt;
    &lt;/channel&gt;
    &lt;channel <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;spicevmc&#39;</span>&gt;
      &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span> <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;com.redhat.spice.0&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio-serial&#39;</span> <span class="nv">controller</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;2&#39;</span>/&gt;
    &lt;/channel&gt;
    &lt;input <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;tablet&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>/&gt;
    &lt;/input&gt;
    &lt;input <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;mouse&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;ps2&#39;</span>/&gt;
    &lt;input <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;ps2&#39;</span>/&gt;
    &lt;graphics <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;spice&#39;</span> <span class="nv">autoport</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span>&gt;
      &lt;listen <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;address&#39;</span>/&gt;
      &lt;image <span class="nv">compression</span><span class="o">=</span><span class="s1">&#39;off&#39;</span>/&gt;
    &lt;/graphics&gt;
    &lt;sound <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;ich9&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x1b&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/sound&gt;
    &lt;video&gt;
      &lt;model <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;qxl&#39;</span> <span class="nv">ram</span><span class="o">=</span><span class="s1">&#39;65536&#39;</span> <span class="nv">vram</span><span class="o">=</span><span class="s1">&#39;65536&#39;</span> <span class="nv">vgamem</span><span class="o">=</span><span class="s1">&#39;16384&#39;</span> <span class="nv">heads</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="nv">primary</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x01&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/video&gt;
    &lt;redirdev <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;spicevmc&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;2&#39;</span>/&gt;
    &lt;/redirdev&gt;
    &lt;redirdev <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;spicevmc&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;3&#39;</span>/&gt;
    &lt;/redirdev&gt;
    &lt;memballoon <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x06&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/memballoon&gt;
    &lt;rng <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>&gt;
      &lt;backend <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;random&#39;</span>&gt;/dev/urandom&lt;/backend&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x07&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/rng&gt;
  &lt;/devices&gt;
&lt;/domain&gt;

</code></pre></div><p>Comprobamos que se ha creado el fichero <strong><code>.qcow2 </code></strong> en el directorio <strong><code>/var/lib/libvirt/images/</code></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# ls
buster-base.qcow2  compilar_default.img  debian-VAGRANTSLASH-buster64_vagrant_box_image_10.4.0.img
</code></pre></div><h3 id="crear-par-de-claves">Crear par de claves</h3>
<blockquote>
<p>Crea un par de claves ssh en formato ecdsa y sin frase de paso y agrega la clave pública al usuario debian</p>
</blockquote>
<p>Creamos el <strong>par de claves</strong> indicado en la máquina anfitriona.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">ssh-keygen -t ecdsa -b <span class="m">521</span>
</code></pre></div><p>En la mv creamos el fichero <strong><code>authorized_keys</code></strong> e introducimos la clave pública.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@debian-kvm:~/.ssh$ cat authorized_keys
ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAF5SCIOXoPk1sXDH43L1r4YqoP15DHGxRfCvat01stXT0YEIeXujgFalyETMu3WqlIjLtca/b5JV4Gk//rk0IdfVQAXhQFgruXQ6e7EYSru0D9XCaTuiJ4oMzoFu/+caYUT+o5HeOSHTWj1EfOqqbJDsuACJ5vvjubPrQ54P6orN3D1dQ<span class="o">==</span> celiagm@debian
</code></pre></div><h3 id="reducir-el-tamaño-virt-sparsify">Reducir el tamaño: virt-sparsify</h3>
<blockquote>
<p>Utiliza la herramienta virt-sparsify para reducir al máximo el tamaño de la imagen</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# virt-sparsify --compress buster-base.qcow2 buster-base_red.qcow2
<span class="o">[</span>   0.0<span class="o">]</span> Create overlay file in /tmp to protect <span class="nb">source</span> disk
<span class="o">[</span>   0.0<span class="o">]</span> Examine <span class="nb">source</span> disk
 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ --:--
<span class="o">[</span>   7,1<span class="o">]</span> Fill free space in /dev/sda1 with zero
<span class="o">[</span>   8,7<span class="o">]</span> Copy to destination and make sparse
<span class="o">[</span>  64,8<span class="o">]</span> Sparsify operation completed with no errors.
virt-sparsify: Before deleting the old disk, carefully check that the
target disk boots and works correctly.

</code></pre></div><p><strong>Comprobamos</strong> que está creada la imagen y <strong>ocupa menos espacio</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# ls -lh
total 5,8G
-rw------- <span class="m">1</span> root         root         3,1G mar <span class="m">22</span> 17:38 buster-base.qcow2
-rw-r--r-- <span class="m">1</span> root         root         377M mar <span class="m">22</span> 17:46 buster-base_red.qcow2

</code></pre></div><h3 id="subir-imagen-a-un-sitio">Subir imagen a un sitio</h3>
<blockquote>
<p>Sube la imagen y la clave privada ssh a alguna ubicación pública desde la que se pueda descargar</p>
</blockquote>
<p>Lo subimos a Mega</p>
<hr>
<h3 id="2-escribe-un-shell-script-que-ejecutado-por-un-usuario-con-acceso-a-qemusystem-realice-los-siguientes-pasos">2. Escribe un shell script que ejecutado por un usuario con acceso a qemu:///system realice los siguientes pasos:</h3>
<h4 id="crear-nueva-imagen-desde-una-imagen-base">Crear nueva imagen desde una imagen base</h4>
<blockquote>
<p><strong>1. Crea una imagen nueva, que utilice <strong><code>buster-base.qcow2</code></strong> como imagen base y tenga 5 GiB de tamaño máximo. Esta imagen se denominará <code>maquina1.qcow2</code></strong></p>
</blockquote>
<p>Creamos la imagen</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">qemu-img create -f qcow2 -b buster-base_red.qcow2 maquina1.qcow2 5G
</code></pre></div><p>Salida:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# qemu-img create -f qcow2 -b buster-base_red.qcow2 maquina1.qcow2 5G
Formatting <span class="s1">&#39;maquina1.qcow2&#39;</span>, <span class="nv">fmt</span><span class="o">=</span>qcow2 <span class="nv">size</span><span class="o">=</span><span class="m">5368709120</span> <span class="nv">backing_file</span><span class="o">=</span>buster-base_red.qcow2 <span class="nv">cluster_size</span><span class="o">=</span><span class="m">65536</span> <span class="nv">lazy_refcounts</span><span class="o">=</span>off <span class="nv">refcount_bits</span><span class="o">=</span><span class="m">16</span>
</code></pre></div><p>Comprobamos que se ha creado <code>maquina1.qcow2</code></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# ls -lh
total 5,8G
-rw------- <span class="m">1</span> root         root         3,1G mar <span class="m">22</span> 17:38 buster-base.qcow2
-rw-r--r-- <span class="m">1</span> root         root         377M mar <span class="m">22</span> 17:46 buster-base_red.qcow2
-rw------- <span class="m">1</span> root         root         3,2G mar <span class="m">18</span> 17:51 compilar_default.img
-rwxr--r-- <span class="m">1</span> libvirt-qemu libvirt-qemu 1,1G ene <span class="m">27</span> 11:01 debian-VAGRANTSLASH-buster64_vagrant_box_image_10.4.0.img
-rw-r--r-- <span class="m">1</span> root         root         193K mar <span class="m">22</span> 18:18 maquina1.qcow2
</code></pre></div><h4 id="crear-red-interna-intra">Crear red interna <code>intra</code></h4>
<blockquote>
<p><strong>2. Crea una red interna de nombre intra con salida al exterior mediante NAT que utilice el direccionamiento <code>10.10.20.0/24</code></strong></p>
</blockquote>
<p>Creamos el nuevo fichero <strong>.xml</strong>.</p>
<p>Le proporcionamos un <strong>identificador</strong> y le proporcionamos una <strong>mac</strong> respetando los tres primeros octetos.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">cat /proc/sys/kernel/random/uuid
</code></pre></div><p><strong><code>intra.xml</code></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;network&gt;
  &lt;name&gt;intra&lt;/name&gt;
  &lt;uuid&gt;697e03ff-85da-45ff-815b-b16170e2125f&lt;/uuid&gt;
  &lt;forward <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;nat&#39;</span>&gt;
    &lt;nat&gt;
      &lt;port <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;1024&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;65535&#39;</span>/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;virbr3&#39;</span> <span class="nv">stp</span><span class="o">=</span><span class="s1">&#39;on&#39;</span> <span class="nv">delay</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
  &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;52:54:00:a1:51:25&#39;</span>/&gt;
  &lt;ip <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;10.10.20.0&#39;</span> <span class="nv">netmask</span><span class="o">=</span><span class="s1">&#39;255.255.255.0&#39;</span>&gt;
    &lt;dhcp&gt;
      &lt;range <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;10.10.20.2&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;10.10.20.254&#39;</span>/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
</code></pre></div><p>La <strong>definimos</strong>, la <strong>iniciamos</strong> y <strong>comprobamos</strong> que esta activo</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu/networks# virsh net-define intra.xml
Network intra defined from intra.xml

root@debian:/etc/libvirt/qemu/networks# virsh net-start intra
Network intra started

root@debian:/home/celiagm/isos# virsh net-autostart intra
Network intra marked as autostarted


root@debian:/home/celiagm/isos# virsh net-list --all
 Name              State      Autostart   Persistent
------------------------------------------------------
 default           active     yes         yes
 intra             active     yes         yes
 red2              active     yes         yes
 vagrant-libvirt   inactive   no          yes

</code></pre></div><h3 id="crear-mv">Crear MV</h3>
<blockquote>
<p><strong>3. Crea una máquina virtual (maquina1) conectada a la red <strong>intra</strong>, con 1 GiB de RAM, que utilice como disco raíz <code>maquina1.qcow2</code> y que se inicie automáticamente. Arranca la máquina.</strong></p>
</blockquote>
<p>Creamos el <strong>dominio</strong>, llamado <strong><code>maquina1.xml</code></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;domain <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;kvm&#34;</span>&gt;
  &lt;name&gt;dominio1&lt;/name&gt;
  &lt;memory <span class="nv">unit</span><span class="o">=</span><span class="s2">&#34;G&#34;</span>&gt;1&lt;/memory&gt;
  &lt;vcpu&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;<span class="nb">type</span> <span class="nv">arch</span><span class="o">=</span><span class="s2">&#34;x86_64&#34;</span>&gt;hvm&lt;/type&gt;
  &lt;/os&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/kvm&lt;/emulator&gt;
    &lt;disk <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span> <span class="nv">device</span><span class="o">=</span><span class="s1">&#39;disk&#39;</span>&gt;
      &lt;driver <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;qcow2&#39;</span>/&gt;
      &lt;<span class="nb">source</span> <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;/var/lib/libvirt/images/maquina1.qcow2&#39;</span>/&gt;
      &lt;target <span class="nv">dev</span><span class="o">=</span><span class="s1">&#39;vda&#39;</span>/&gt;
    &lt;/disk&gt;
    &lt;interface <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;network&#34;</span>&gt;
      &lt;<span class="nb">source</span> <span class="nv">network</span><span class="o">=</span><span class="s2">&#34;intra&#34;</span>/&gt;
      &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s2">&#34;52:54:00:87:c1:a5&#34;</span>/&gt;
    &lt;/interface&gt;
    &lt;graphics <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;vnc&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;-1&#39;</span> <span class="nv">autoport</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span> <span class="nv">listen</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span> /&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre></div><p>Comprobamos que es <strong>válido</strong> el fichero xml</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu# virt-xml-validate maquina1.xml
maquina1.xml validates
</code></pre></div><p><strong>Definimos y arrancamos la máquina</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu# virsh define maquina1.xml
Domain maquina1 defined from maquina1.xml

root@debian:/etc/libvirt/qemu# virsh start maquina1
Domain maquina1 started
</code></pre></div><p>Comprobamos que está <strong>encendida</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu# virsh list --all
 Id   Name               State
-----------------------------------
 <span class="m">3</span>    maquina1           running
 -    buster-base        shut off
 -    compilar_default   shut off

</code></pre></div><p>Nos <strong>conectamos</strong> a ella</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ virt-viewer -c qemu:///system maquina1
</code></pre></div><h3 id="crear-volumen-adicional-raw-pool-por-defecto">Crear volumen adicional RAW (pool por defecto)</h3>
<blockquote>
<p><strong>4. Crea un <strong>volumen adicional</strong> de 1 GiB de tamaño en formato <strong>RAW</strong> ubicado en el pool por defecto</strong></p>
</blockquote>
<p>Creamos el <strong>xml</strong> del volumen de <strong>1Gb</strong></p>
<p><code>vol.xml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;volume <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span>&gt;
  &lt;name&gt;vol1.img&lt;/name&gt;
  &lt;key&gt;/var/lib/libvirt/images/vol1.img&lt;/key&gt;
  &lt;source&gt;
  &lt;/source&gt;
  &lt;allocation&gt;0&lt;/allocation&gt;
  &lt;capacity <span class="nv">unit</span><span class="o">=</span><span class="s2">&#34;G&#34;</span>&gt;1&lt;/capacity&gt;
  &lt;target&gt;
    &lt;path&gt;/var/lib/libvirt/images/vol1.img&lt;/path&gt;
    &lt;format <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span>/&gt;
  &lt;/target&gt;
&lt;/volume&gt;
</code></pre></div><p>Creamos el volumen en el <strong>pool por defecto</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# virsh vol-create default vol.xml
Vol vol1.img created from vol.xml
</code></pre></div><h3 id="listar-volumenes">Listar volumenes</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# virsh vol-list default
 Name                                                        Path
------------------------------------------------------------------------------------------------------------------------------------------------
 buster-base.qcow2                                           /var/lib/libvirt/images/buster-base.qcow2
 compilar_default.img                                        /var/lib/libvirt/images/compilar_default.img
 debian-VAGRANTSLASH-buster64_vagrant_box_image_10.4.0.img   /var/lib/libvirt/images/debian-VAGRANTSLASH-buster64_vagrant_box_image_10.4.0.img
 vol1.img                                                    /var/lib/libvirt/images/vol1.img
</code></pre></div><h3 id="gestión-del-volumen-nuevo-para-postgresql">Gestión del volumen nuevo para postgresql</h3>
<blockquote>
<p><strong>5. Una vez iniciada la MV maquina1, conecta el volumen a la máquina, crea un sistema de ficheros XFS en el volumen y móntalo en el directorio <code>/var/lib/postgresql</code>. Ten cuidado con los <strong>propietarios</strong> y <strong>grupos</strong> que pongas, para que funcione adecuadamente el siguiente punto.</strong></p>
</blockquote>
<p>Conectamos el volumen creado de <strong>1Gb</strong> a la máquina</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"> <span class="n">root</span><span class="nv">@debian</span><span class="err">:</span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">libvirt</span><span class="p">/</span><span class="n">images</span><span class="c"># virsh attach-disk maquina1 --source /var/lib/libvirt/images/vol1.img --target vdc --persistent</span>
<span class="n">Disk</span> <span class="n">attached</span> <span class="n">successfully</span>

</code></pre></div><p>Le damos formato <strong>XFS</strong> , para ello tenemos que intalar los siguientes paquetes</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">sudo</span> <span class="n">apt-get</span> <span class="n">install</span> <span class="n">xfsprogs</span> <span class="n">dosfstools</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">root</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">debian</span><span class="c"># mkfs</span>
<span class="n">mkfs</span>         <span class="n">mkfs</span><span class="p">.</span><span class="n">cramfs</span>  <span class="n">mkfs</span><span class="p">.</span><span class="n">ext3</span>    <span class="n">mkfs</span><span class="p">.</span><span class="n">fat</span>     <span class="n">mkfs</span><span class="p">.</span><span class="n">msdos</span>   <span class="n">mkfs</span><span class="p">.</span><span class="n">xfs</span>
<span class="n">mkfs</span><span class="p">.</span><span class="n">bfs</span>     <span class="n">mkfs</span><span class="p">.</span><span class="n">ext2</span>    <span class="n">mkfs</span><span class="p">.</span><span class="n">ext4</span>    <span class="n">mkfs</span><span class="p">.</span><span class="n">minix</span>   <span class="n">mkfs</span><span class="p">.</span><span class="n">vfat</span>
<span class="n">root</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">debian</span><span class="c"># lsblk -l</span>
<span class="n">NAME</span> <span class="n">MAJ</span><span class="err">:</span><span class="n">MIN</span> <span class="nb">RM </span><span class="n">SIZE</span> <span class="n">RO</span> <span class="nb">TYPE </span><span class="n">MOUNTPOINT</span>
<span class="n">vda</span>  <span class="n">254</span><span class="err">:</span><span class="n">0</span>    <span class="n">0</span>   <span class="n">5G</span>  <span class="n">0</span> <span class="n">disk</span>
<span class="n">vda1</span> <span class="n">254</span><span class="err">:</span><span class="n">1</span>    <span class="n">0</span>   <span class="n">3G</span>  <span class="n">0</span> <span class="n">part</span> <span class="p">/</span>
<span class="n">vdb</span>  <span class="n">254</span><span class="err">:</span><span class="n">16</span>   <span class="n">0</span>   <span class="n">1G</span>  <span class="n">0</span> <span class="n">disk</span>
<span class="n">root</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">debian</span><span class="c"># mkfs.xfs /dev/vdb</span>
<span class="n">meta-data</span><span class="p">=/</span><span class="n">dev</span><span class="p">/</span><span class="n">vdb</span>               <span class="n">isize</span><span class="p">=</span><span class="n">512</span>    <span class="n">agcount</span><span class="p">=</span><span class="n">4</span><span class="p">,</span> <span class="n">agsize</span><span class="p">=</span><span class="n">65536</span> <span class="n">blks</span>
         <span class="p">=</span>                       <span class="n">sectsz</span><span class="p">=</span><span class="n">512</span>   <span class="n">attr</span><span class="p">=</span><span class="n">2</span><span class="p">,</span> <span class="n">projid32bit</span><span class="p">=</span><span class="n">1</span>
         <span class="p">=</span>                       <span class="n">crc</span><span class="p">=</span><span class="n">1</span>        <span class="n">finobt</span><span class="p">=</span><span class="n">1</span><span class="p">,</span> <span class="n">sparse</span><span class="p">=</span><span class="n">1</span><span class="p">,</span> <span class="n">rmapbt</span><span class="p">=</span><span class="n">0</span>
         <span class="p">=</span>                       <span class="n">reflink</span><span class="p">=</span><span class="n">0</span>
<span class="n">data</span>     <span class="p">=</span>                       <span class="n">bsize</span><span class="p">=</span><span class="n">4096</span>   <span class="n">blocks</span><span class="p">=</span><span class="n">262144</span><span class="p">,</span> <span class="n">imaxpct</span><span class="p">=</span><span class="n">25</span>
         <span class="p">=</span>                       <span class="n">sunit</span><span class="p">=</span><span class="n">0</span>      <span class="n">swidth</span><span class="p">=</span><span class="n">0</span> <span class="n">blks</span>
<span class="n">naming</span>   <span class="p">=</span><span class="n">version</span> <span class="n">2</span>              <span class="n">bsize</span><span class="p">=</span><span class="n">4096</span>   <span class="n">ascii-ci</span><span class="p">=</span><span class="n">0</span><span class="p">,</span> <span class="n">ftype</span><span class="p">=</span><span class="n">1</span>
<span class="n">log</span>      <span class="p">=</span><span class="n">internal</span> <span class="n">log</span>           <span class="n">bsize</span><span class="p">=</span><span class="n">4096</span>   <span class="n">blocks</span><span class="p">=</span><span class="n">2560</span><span class="p">,</span> <span class="n">version</span><span class="p">=</span><span class="n">2</span>
         <span class="p">=</span>                       <span class="n">sectsz</span><span class="p">=</span><span class="n">512</span>   <span class="n">sunit</span><span class="p">=</span><span class="n">0</span> <span class="n">blks</span><span class="p">,</span> <span class="n">lazy-count</span><span class="p">=</span><span class="n">1</span>
<span class="n">realtime</span> <span class="p">=</span><span class="n">none</span>                   <span class="n">extsz</span><span class="p">=</span><span class="n">4096</span>   <span class="n">blocks</span><span class="p">=</span><span class="n">0</span><span class="p">,</span> <span class="n">rtextents</span><span class="p">=</span><span class="n">0</span>
<span class="n">root</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">debian</span><span class="c"># lsblk -f</span>
<span class="n">NAME</span>   <span class="n">FSTYPE</span> <span class="n">LABEL</span> <span class="n">UUID</span>                                 <span class="n">FSAVAIL</span> <span class="n">FSUSE</span><span class="p">%</span> <span class="n">MOUNTPOINT</span>
<span class="n">vda</span>
<span class="err">└─</span><span class="n">vda1</span> <span class="n">xfs</span>          <span class="n">30a9cfb1</span><span class="p">-</span><span class="n">0b31</span><span class="p">-</span><span class="n">4368</span><span class="p">-</span><span class="n">8b7a-c6779804e450</span>      <span class="n">2G</span>    <span class="n">35</span><span class="p">%</span> <span class="p">/</span>
<span class="n">vdb</span>    <span class="n">xfs</span>          <span class="n">6ebae309</span><span class="p">-</span><span class="n">2c2f</span><span class="p">-</span><span class="n">4c67-b098</span><span class="p">-</span><span class="n">20a9afbda1a5</span>
</code></pre></div><h3 id="conceder-permisos-adecuados">Conceder permisos adecuados</h3>
<p>Antes de montarlo en el directorio <code>/var/lib/postgresql.</code> vamos a ver qué permisos tenemos que darle y que usuarios tenemos que crear para la base de datos en postgresql.</p>
<p>Creamos el <strong>grupo postgres</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">debian</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">~$</span> <span class="n">sudo</span> <span class="n">groupadd</span> <span class="n">postgres</span>

<span class="n">debian</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">~$</span> <span class="n">sudo</span> <span class="n">useradd</span> <span class="n">postgres</span> <span class="n">-m</span> <span class="n">-g</span> <span class="n">postgres</span>
</code></pre></div><p><strong>Creamos el directorio</strong> y le damos los <strong>permisos adecuados</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">root</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="c"># mkdir postgresql</span>
<span class="n">root</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="c"># chown -R postgres:postgres postgresql/</span>
<span class="n">root</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="c"># ls -l | grep &#39;post&#39;</span>
<span class="n">drwxr-xr-x</span> <span class="n">2</span> <span class="n">postgres</span> <span class="n">postgres</span>   <span class="n">6</span> <span class="n">abr</span>  <span class="n">5</span> <span class="n">19</span><span class="err">:</span><span class="n">50</span> <span class="n">postgresql</span>
</code></pre></div><p><strong>Montamos el disco</strong> en el directorio requerido</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">root</span><span class="nv">@debian</span><span class="n">-kvm</span><span class="err">:</span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="c"># mount -t xfs /dev/vdb /var/lib/postgresql/</span>
</code></pre></div><p>Comprobamos que se ha montado</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian-kvm:/var/lib# lsblk -f 
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 xfs          30a9cfb1-0b31-4368-8b7a-c6779804e450    1,7G    43% /
vdb    xfs          6ebae309-2c2f-4c67-b098-20a9afbda1a5  980,8M     3% /var/lib/postgresql

</code></pre></div><h3 id="instalar-postgresql-vía-ssh">Instalar postgresql vía ssh</h3>
<blockquote>
<p><strong>6. Instala en maquina1 el sistema de BBDD <strong>PostgreSQL</strong> que ubicará sus ficheros con las bases de datos en <code>/var/lib/postgresql</code> utilizando una conexión ssh.</strong></p>
</blockquote>
<p>Accedemos por <strong>ssh</strong> a la mv.</p>
<p>Instalamos <strong>prostgres</strong> como se indica en el siguiente <a href="https://www.celiagm.es/post/postgresql_debian/">post</a></p>
<p>Comprobamos que se ha creado el directorio <strong>11</strong> correspondiente a la versión de postgresql.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian-kvm:/var/lib/postgresql# ls -lh
total <span class="m">0</span>
drwxr-xr-x <span class="m">3</span> postgres postgres <span class="m">18</span> abr  <span class="m">7</span> 15:11 <span class="m">11</span>
</code></pre></div><p>Vamos a darle una <strong>contraseña</strong> al usuario postgres</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">passwd</span> <span class="n">postgres</span>
</code></pre></div><h3 id="poblar-la-base-de-datos-de-postgresql">Poblar la base de datos de PostgreSQL</h3>
<blockquote>
<p><strong>7. (Opcional) <strong>Puebla la base de datos</strong> con una BBDD de prueba (escribe en la tarea el nombre de usuario y contraseña para acceder a la BBDD).</strong></p>
</blockquote>
<p>Creamos el usario <code>celia</code> y la base de datos <code>prueba</code></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@debian-kvm:~$ sudo su
root@debian-kvm:/home/debian# su - postgresql
su: el usuario postgresql no existe
root@debian-kvm:/home/debian# su - postgres
$ psql	
psql <span class="o">(</span>11.11 <span class="o">(</span>Debian 11.11-1.pgdg100+1<span class="o">))</span>
Digite «help» para obtener ayuda.

<span class="nv">postgres</span><span class="o">=</span><span class="c1"># create user celia with password &#39;celia&#39;;</span>
CREATE ROLE
<span class="nv">postgres</span><span class="o">=</span><span class="c1"># create database prueba;</span>
CREATE DATABASE
<span class="nv">postgres</span><span class="o">=</span><span class="c1"># grant all privileges on database prueba to celia;</span>
GRANT
<span class="nv">postgres</span><span class="o">=</span><span class="c1"># exit</span>
</code></pre></div><p>Entramos como usuario <strong>celia</strong> y poblamos la base de datos</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">psql -h localhost -U celia -W -d prueba

</code></pre></div><p>Agregamos una tabla de <strong>prueba</strong> con sus registros</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">create table departamento<span class="o">(</span>
dept_no integer,
dnombre varchar<span class="o">(</span>20<span class="o">)</span>,
loc varchar<span class="o">(</span>20<span class="o">)</span>,
primary key <span class="o">(</span>dept_no<span class="o">)</span>
<span class="o">)</span><span class="p">;</span>

-- Añadimos registros 

insert into departamento
values <span class="o">(</span><span class="s1">&#39;10&#39;</span>,<span class="s1">&#39;CONTABILIDAD&#39;</span>,<span class="s1">&#39;SEVILLA&#39;</span><span class="o">)</span><span class="p">;</span>
insert into departamento
values <span class="o">(</span><span class="s1">&#39;20&#39;</span>,<span class="s1">&#39;INVESTIGACION&#39;</span>,<span class="s1">&#39;MADRID&#39;</span><span class="o">)</span><span class="p">;</span>
insert into departamento
values <span class="o">(</span><span class="s1">&#39;30&#39;</span>,<span class="s1">&#39;VENTAS&#39;</span>,<span class="s1">&#39;BARCELONA&#39;</span><span class="o">)</span><span class="p">;</span>
insert into departamento
values <span class="o">(</span><span class="s1">&#39;40&#39;</span>,<span class="s1">&#39;PRODUCCION&#39;</span>,<span class="s1">&#39;BILBAO&#39;</span><span class="o">)</span><span class="p">;</span>
</code></pre></div><p>Mostramos la tabla con los registros</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">prueba</span><span class="o">=</span>&gt; <span class="se">\d</span>
         Listado de relaciones
 Esquema <span class="p">|</span>    Nombre    <span class="p">|</span> Tipo  <span class="p">|</span> Dueño 
---------+--------------+-------+-------
 public  <span class="p">|</span> departamento <span class="p">|</span> tabla <span class="p">|</span> celia
<span class="o">(</span><span class="m">1</span> fila<span class="o">)</span>

<span class="nv">prueba</span><span class="o">=</span>&gt; <span class="k">select</span> * from departamento<span class="p">;</span>
 dept_no <span class="p">|</span>    dnombre    <span class="p">|</span>    loc    
---------+---------------+-----------
      <span class="m">10</span> <span class="p">|</span> CONTABILIDAD  <span class="p">|</span> SEVILLA
      <span class="m">20</span> <span class="p">|</span> INVESTIGACION <span class="p">|</span> MADRID
      <span class="m">30</span> <span class="p">|</span> VENTAS        <span class="p">|</span> BARCELONA
      <span class="m">40</span> <span class="p">|</span> PRODUCCION    <span class="p">|</span> BILBAO
<span class="o">(</span><span class="m">4</span> filas<span class="o">)</span>

</code></pre></div><h3 id="regla-nat">Regla NAT</h3>
<blockquote>
<p><strong>8. Crea una <strong>regla de NAT</strong> para que la base de datos sea accesible desde el exterior</strong></p>
</blockquote>
<p>Ahora vamos a <strong>editar el fichero de configuracion de postgres</strong> para hacer que sea accesible desde otras maquinas</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">nano</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">postgresql</span><span class="p">/</span><span class="n">11</span><span class="p">/</span><span class="n">main</span><span class="p">/</span><span class="n">postgresql</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div><p>Buscamos las líneas siguientes y las modificamos así, de tal forma que sea accesible desde el exterior.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">listen_addresses</span> <span class="p">=</span> <span class="s1">&#39;*&#39;</span>          <span class="c"># what IP address(es) to listen on;</span>

<span class="c">#unix_socket_group = &#39;&#39;                 # (change requires restart)</span>
<span class="n">unix_socket_permissions</span> <span class="p">=</span> <span class="n">0700</span>          <span class="c"># begin with 0 to use octal notation</span>

</code></pre></div><p><strong>Editamos</strong> el siguiente fichero también y cambiamos lo siguiente</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell">
<span class="n">nano</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">postgresql</span><span class="p">/</span><span class="n">11</span><span class="p">/</span><span class="n">main</span><span class="p">/</span><span class="n">pg_hba</span><span class="p">.</span><span class="n">conf</span>

</code></pre></div><p><strong>Cambiamos</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># IPv4 local connections:</span>
<span class="n">host</span>    <span class="n">all</span>             <span class="n">all</span>             <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">/</span><span class="n">32</span>            <span class="n">md5</span>

<span class="c"># lo cambiamos por</span>

<span class="n">host</span>    <span class="n">all</span>             <span class="n">all</span>             <span class="n">all</span>                   <span class="n">md5</span>
</code></pre></div><p>Para <strong>permitir las conexiones desde cualquier dirección ip</strong> con cualquier <strong>usuario</strong> y base de datos (si éste tiene permiso para ello).</p>
<p>Ahora <strong>reiniciamos el servicio de postgres</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">postgresql</span>
</code></pre></div><p>Comprobamos que está funcionando</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian-kvm:/# sudo systemctl status postgresql
● postgresql.service - PostgreSQL RDBMS
   Loaded: loaded <span class="o">(</span>/lib/systemd/system/postgresql.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
   Active: active <span class="o">(</span>exited<span class="o">)</span> since Wed 2021-03-31 22:18:03 CEST<span class="p">;</span> 5s ago
  Process: <span class="m">3249</span> <span class="nv">ExecStart</span><span class="o">=</span>/bin/true <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
 Main PID: <span class="m">3249</span> <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>

mar <span class="m">31</span> 22:18:03 debian-kvm systemd<span class="o">[</span>1<span class="o">]</span>: Starting PostgreSQL RDBMS...
mar <span class="m">31</span> 22:18:03 debian-kvm systemd<span class="o">[</span>1<span class="o">]</span>: Started PostgreSQL RDBMS.

</code></pre></div><p>Ahora que está accesible solo tenemos que crear la regla NAT</p>
<p>Primero miramos por donde está escuchando postgres</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian-kvm:/home/debian# netstat -tlpn
Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      408/sshd            
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:5432            0.0.0.0:*               LISTEN      8164/postgres       
tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      408/sshd            
tcp6       <span class="m">0</span>      <span class="m">0</span> :::5432                 :::*                    LISTEN      8164/postgres    
</code></pre></div><p>Comprobamos que es el puerto <strong>5434</strong>, por lo tanto</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">sudo iptables -A INPUT -p tcp -s 10.10.20.158/24 --dport <span class="m">5432</span> -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -p tcp --sport <span class="m">5432</span> -m state --state ESTABLISHED -j ACCEPT
</code></pre></div><h3 id="acceso-remoto-a-la-base-de-datos-anfitriona---maquina-virtual">Acceso remoto a la base de datos (anfitriona - maquina virtual)</h3>
<p>Comprobamos que podemos acceder desde la máquina anfitriona y podemos ver la tabla creada. Le pasaremos el parámetro -h (host) &ndash;port (puerto ) -U (usuario) -W (contraseña de forma forzada)</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">celiagm@debian:~$ psql -h 10.10.20.158 --port <span class="m">5432</span> -U celia -W prueba
Contraseña: 
psql <span class="o">(</span>11.11 <span class="o">(</span>Debian 11.11-0+deb10u1<span class="o">))</span>
conexión SSL <span class="o">(</span>protocolo: TLSv1.3, cifrado: TLS_AES_256_GCM_SHA384, bits: 256, compresión: desactivado<span class="o">)</span>
Digite «help» para obtener ayuda.

<span class="nv">prueba</span><span class="o">=</span>&gt; <span class="se">\d</span>
         Listado de relaciones
 Esquema <span class="p">|</span>    Nombre    <span class="p">|</span> Tipo  <span class="p">|</span> Dueño 
---------+--------------+-------+-------
 public  <span class="p">|</span> departamento <span class="p">|</span> tabla <span class="p">|</span> celia
<span class="o">(</span><span class="m">1</span> fila<span class="o">)</span>

<span class="nv">prueba</span><span class="o">=</span>&gt; 


</code></pre></div><h3 id="punto-de-control">Punto de control</h3>
<blockquote>
<p><strong>9. Pausa la ejecución para comprobar los pasos hasta este punto</strong></p>
</blockquote>
<p>Los pasos hasta aquí parecen correctos. (El script nos mostraría un OK)</p>
<blockquote>
<p><strong>10. Continúa la ejecución cuando el usuario pulse &lsquo;C&rsquo;</strong></p>
</blockquote>
<h3 id="crear-imagen-nueva-desde-imagen-base-maquina2">Crear imagen nueva desde imagen base: maquina2</h3>
<blockquote>
<p><strong>11. Crea una imagen que utilice <code>buster-base.qcow2</code> como imagen base y que tenga un tamaño de 4 GiB. Esta imagen se llamará <code>maquina2.qcow2</code></strong></p>
</blockquote>
<p>Hacemos el mismo procedimiento que al principio</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">qemu-img create -f qcow2 -b buster-base_red.qcow2 maquina2.qcow2 4G
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# qemu-img create -f qcow2 -b buster-base_red.qcow2 maquina2.qcow2 4G
Formatting <span class="s1">&#39;maquina2.qcow2&#39;</span>, <span class="nv">fmt</span><span class="o">=</span>qcow2 <span class="nv">size</span><span class="o">=</span><span class="m">4294967296</span> <span class="nv">backing_file</span><span class="o">=</span>buster-base_red.qcow2 <span class="nv">cluster_size</span><span class="o">=</span><span class="m">65536</span> <span class="nv">lazy_refcounts</span><span class="o">=</span>off <span class="nv">refcount_bits</span><span class="o">=</span><span class="m">16</span>
</code></pre></div><ul>
<li>Comprobamos que se ha creado también la <strong>máquina2</strong>.</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# ls -lh <span class="p">|</span> grep <span class="s1">&#39;maquina&#39;</span>
-rw-r--r-- <span class="m">1</span> libvirt-qemu libvirt-qemu 347M abr  <span class="m">5</span> 19:32 maquina1.qcow2
-rw-r--r-- <span class="m">1</span> root         root         193K abr  <span class="m">5</span> 19:33 maquina2.qcow2

</code></pre></div><p><strong>12. Crea una nueva máquina (maquina2) que utilice imagen anterior, con 1 GiB de RAM y que también esté conectada a <strong>intra</strong>.</strong></p>
<p><strong>13. Para el servicio postgreSQL, desmonta el dispositivo de bloques, desmonta el volumen de maquina1, monta el volumen en maquina2 en el directorio /var/lib/pgsql teniendo de nuevo cuidado con los propietarios y permisos del directorio.</strong></p>
</div>
        <div class="post-footer">
            <div class="info">
                
                <span class="separator"><a class="tag" href="/tags/libvirt/">libvirt</a><a class="tag" href="/tags/kvm/">kvm</a></span>

            </div>
        </div>

        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://www.celiagm.es/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script></body>

</html>
