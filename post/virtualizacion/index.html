<!DOCTYPE html>
<html lang="en" data-theme=""><head>
    <title> Celia García Márquez </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.80.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Blog sobre informática">
    
    <link rel="stylesheet"
          href="https://1bit1nfo.netlify.app/css/style.min.93ab6bdd416e6acc85a43e3a7629dda51ac58cbb8d193f5e62dc5d448bc2b385.css"
          integrity="sha256-k6tr3UFuasyFpD46dindpRrFjLuNGT9eYtxdRIvCs4U="
          crossorigin="anonymous"
          type="text/css">
    
    <link rel="stylesheet"
        href="https://1bit1nfo.netlify.app/css/markupHighlight.min.4ac4c94828876abc926f5563ef81e319b441b25cad2c96842d2b87fd204a0de6.css"
        integrity="sha256-SsTJSCiHarySb1Vj74HjGbRBslytLJaELSuH/SBKDeY="
        crossorigin="anonymous"
        type="text/css">
    
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="https://1bit1nfo.netlify.app/favicons/favicon.icofavicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://1bit1nfo.netlify.app/favicons/favicon.icoapple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://1bit1nfo.netlify.app/favicons/favicon.icofavicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://1bit1nfo.netlify.app/favicons/favicon.icofavicon-16x16.png">

    <link rel="canonical" href="https://1bit1nfo.netlify.app/post/virtualizacion/">

    
    
    
    
    <script type="text/javascript"
            src="https://1bit1nfo.netlify.app/js/anatole-header.min.d8599ee07b7d3f11bafbac30657ccc591e8d7fd36a9f580cd4c09e24e0e4a971.js"
            integrity="sha256-2Fme4Ht9PxG6&#43;6wwZXzMWR6Nf9Nqn1gM1MCeJODkqXE="
            crossorigin="anonymous"></script>


    
        
        
        <script type="text/javascript"
                src="https://1bit1nfo.netlify.app/js/anatole-theme-switcher.min.e289e9ebb2a4e7a7f895859c8a2b0da2de1ec73f22cea58d8475aa0597023837.js"
                integrity="sha256-4onp67Kk56f4lYWciisNot4exz8izqWNhHWqBZcCODc="
                crossorigin="anonymous"></script>
    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://1bit1nfo.netlify.app/images/avatar_red.jpg"/>

<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Crea con virt-install una imagen de Debian Buster con formato qcow2 y un tamaño máximo de 3GiB."/>


    

</head>
<body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="https://1bit1nfo.netlify.app/images/avatar_red.jpg" alt="profile picture">
            <h3 title=""><a href="/">Un bit de información cada día</a></h3>
            <div class="description">
                <p>Blog sobre informática</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="https://www.linkedin.com/in/cgmarquez/" rel="me" aria-label="Linkedin">
                    <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/CeliaGMqrz" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="mailto:cg.marquez95@gmail.com" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; Celia García Márquez  2020-2021 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Inicio</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">Sobre mí</a></li>
        
        
        
            <li class="theme-switch-item">
                <a class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post  animated fadeInDown ">
        <div class="post-content">
            
            <div class="post-title">
                <h3></h3>
                
                    <div class="info">
                        <em class="fas fa-calendar-day"></em>
                        <span class="date"> Mon, Jan 1, 0001 
                                           </span>
                        <em class="fas fa-stopwatch"></em>
                        <span class="reading-time">8-minute read</span>
                    </div>
                
            </div>

            <ol>
<li>Crea con <code>virt-install</code> una imagen de Debian Buster con formato qcow2 y un tamaño máximo de 3GiB. Esta imagen se denominará <code>buster-base.qcow2</code>. El sistema de ficheros del sistema instalado en esta imagen será XFS. La imagen debe estar configurada para
poder usar hasta dos interfaces de red por dhcp. El usuario <code>debian</code> con contraseña <code>debian</code> puede utilizar sudo sin contraseña.</li>
</ol>
<h3 id="crear-redes">Crear redes</h3>
<p>Primero tenemos que crear las redes que necesitamos, en este caso usaremos la default que es &lsquo;virbr0&rsquo; y una nueva que vamos a crear &lsquo;virbr2&rsquo;.</p>
<ul>
<li>La red default tiene estas caracteristicas:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;4a90cfb3-6969-40c7-99df-d2440cca4d1b&lt;/uuid&gt;
  &lt;forward <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;nat&#39;</span>/&gt;
  &lt;bridge <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;virbr0&#39;</span> <span class="nv">stp</span><span class="o">=</span><span class="s1">&#39;on&#39;</span> <span class="nv">delay</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
  &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;52:54:00:b0:ec:fd&#39;</span>/&gt;
  &lt;ip <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;192.168.122.1&#39;</span> <span class="nv">netmask</span><span class="o">=</span><span class="s1">&#39;255.255.255.0&#39;</span>&gt;
    &lt;dhcp&gt;
      &lt;range <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;192.168.122.2&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;192.168.122.254&#39;</span>/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;

</code></pre></div><p>Actualmente tenemos dos redes, una es la que está por defecto y la otra es una que ha creado vagrant llamada virbr1 (esta no la vamos a usar), por lo que vamos a crear la virbr2</p>
<ul>
<li>Creamos la red virbr2, dándole un direccionamiento 192.168.200.0/24 haciendo nat</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">nano red2.xml
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;network&gt;
  &lt;name&gt;red2&lt;/name&gt;
  &lt;forward <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;nat&#39;</span>&gt;
    &lt;nat&gt;
      &lt;port <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;1024&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;65535&#39;</span>/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;virbr2&#39;</span> <span class="nv">stp</span><span class="o">=</span><span class="s1">&#39;on&#39;</span> <span class="nv">delay</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
  &lt;ip <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;192.168.200.1&#39;</span> <span class="nv">netmask</span><span class="o">=</span><span class="s1">&#39;255.255.255.0&#39;</span>&gt;
    &lt;dhcp&gt;
      &lt;range <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;192.168.200.2&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;192.168.200.254&#39;</span>/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;

</code></pre></div><ul>
<li>Definimos la nueva red virbr2</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu/networks# virsh net-define red2.xml 
Network red2 defined from red2.xml
</code></pre></div><ul>
<li>Listamos las redes que tenemos</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu/networks# virsh net-list --all
 Name              State      Autostart   Persistent
------------------------------------------------------
 default           inactive   no          yes
 red2              active     no          no
 vagrant-libvirt   inactive   no          yes

</code></pre></div><ul>
<li>Iniciamos las redes oportunas, las marcamos como autostart</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">https://1bit1nfo.netlify.app/post/migracion_app_mv/
</code></pre></div><ul>
<li>Listamos las redes y comprobamos que estan activas</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu/networks# virsh net-list --all
 Name              State      Autostart   Persistent
------------------------------------------------------
 default           active     yes         yes
 red2              active     yes         yes
 vagrant-libvirt   inactive   no          yes
</code></pre></div><h3 id="crear-imagen">Crear imagen</h3>
<p>Una vez creadas las redes y activadas vamos a crear la mv con la imagen qcow2</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">virt-install --connect qemu:///system --name buster-base --cdrom ~/isos/debian-10.8.0-amd64-netinst.iso --disk <span class="nv">size</span><span class="o">=</span><span class="m">3</span> --network <span class="nv">bridge</span><span class="o">=</span>virbr0 --network <span class="nv">bridge</span><span class="o">=</span>virbr2 --memory <span class="m">1024</span> --vcpus <span class="m">1</span>
</code></pre></div><p>Hacemos la instalación, teniendo en cuenta el sistema de archivos con formato XFS.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@debian-kvm:~$ lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
sr0                                                                     
vda                                                                     
└─vda1 xfs          30a9cfb1-0b31-4368-8b7a-c6779804e450      2G    35% /

</code></pre></div><p>Cuando se haya finalizado la instalación vamos a descargar sudo.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">su -
apt install sudo 
adduser debian sudo 
nano /etc/sudoers
</code></pre></div><ul>
<li>Editar y poner lo siguiente</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># User privilege specification</span>
root    <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> ALL
debian <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> ALL
<span class="c1"># Allow members of group sudo to execute any command</span>
%sudo   <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> ALL
%debian <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> ALL
debian <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD:ALL
</code></pre></div><p>Comprobamos que se ha creado el archivo buster-base.xml</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">celiagm@debian:/etc/libvirt/qemu$ sudo cat buster-base.xml 
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit buster-base
or other application using the libvirt API.
--&gt;

&lt;domain <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;kvm&#39;</span>&gt;
  &lt;name&gt;buster-base&lt;/name&gt;
  &lt;uuid&gt;01dd42ef-072b-4a96-9108-e62a19260b2e&lt;/uuid&gt;
  &lt;metadata&gt;
    &lt;libosinfo:libosinfo xmlns:libosinfo<span class="o">=</span><span class="s2">&#34;http://libosinfo.org/xmlns/libvirt/domain/1.0&#34;</span>&gt;
      &lt;libosinfo:os <span class="nv">id</span><span class="o">=</span><span class="s2">&#34;http://debian.org/debian/10&#34;</span>/&gt;
    &lt;/libosinfo:libosinfo&gt;
  &lt;/metadata&gt;
  &lt;memory <span class="nv">unit</span><span class="o">=</span><span class="s1">&#39;KiB&#39;</span>&gt;1048576&lt;/memory&gt;
  &lt;currentMemory <span class="nv">unit</span><span class="o">=</span><span class="s1">&#39;KiB&#39;</span>&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu <span class="nv">placement</span><span class="o">=</span><span class="s1">&#39;static&#39;</span>&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;<span class="nb">type</span> <span class="nv">arch</span><span class="o">=</span><span class="s1">&#39;x86_64&#39;</span> <span class="nv">machine</span><span class="o">=</span><span class="s1">&#39;pc-q35-3.1&#39;</span>&gt;hvm&lt;/type&gt;
    &lt;boot <span class="nv">dev</span><span class="o">=</span><span class="s1">&#39;hd&#39;</span>/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;vmport <span class="nv">state</span><span class="o">=</span><span class="s1">&#39;off&#39;</span>/&gt;
  &lt;/features&gt;
  &lt;cpu <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;host-model&#39;</span> <span class="nv">check</span><span class="o">=</span><span class="s1">&#39;partial&#39;</span>&gt;
    &lt;model <span class="nv">fallback</span><span class="o">=</span><span class="s1">&#39;allow&#39;</span>/&gt;
  &lt;/cpu&gt;
  &lt;clock <span class="nv">offset</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span>&gt;
    &lt;timer <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;rtc&#39;</span> <span class="nv">tickpolicy</span><span class="o">=</span><span class="s1">&#39;catchup&#39;</span>/&gt;
    &lt;timer <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pit&#39;</span> <span class="nv">tickpolicy</span><span class="o">=</span><span class="s1">&#39;delay&#39;</span>/&gt;
    &lt;timer <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;hpet&#39;</span> <span class="nv">present</span><span class="o">=</span><span class="s1">&#39;no&#39;</span>/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem <span class="nv">enabled</span><span class="o">=</span><span class="s1">&#39;no&#39;</span>/&gt;
    &lt;suspend-to-disk <span class="nv">enabled</span><span class="o">=</span><span class="s1">&#39;no&#39;</span>/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
    &lt;disk <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span> <span class="nv">device</span><span class="o">=</span><span class="s1">&#39;disk&#39;</span>&gt;
      &lt;driver <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;qcow2&#39;</span>/&gt;
      &lt;<span class="nb">source</span> <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;/var/lib/libvirt/images/buster-base.qcow2&#39;</span>/&gt;
      &lt;target <span class="nv">dev</span><span class="o">=</span><span class="s1">&#39;vda&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x05&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/disk&gt;
    &lt;disk <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span> <span class="nv">device</span><span class="o">=</span><span class="s1">&#39;cdrom&#39;</span>&gt;
      &lt;driver <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span>/&gt;
      &lt;target <span class="nv">dev</span><span class="o">=</span><span class="s1">&#39;sda&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;sata&#39;</span>/&gt;
      &lt;readonly/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;drive&#39;</span> <span class="nv">controller</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">target</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">unit</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
    &lt;/disk&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;qemu-xhci&#39;</span> <span class="nv">ports</span><span class="o">=</span><span class="s1">&#39;15&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x03&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;sata&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x1f&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x2&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root&#39;</span>/&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio-serial&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x04&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x10&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span> <span class="nv">multifunction</span><span class="o">=</span><span class="s1">&#39;on&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;2&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;2&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x11&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x1&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;3&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;3&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x12&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x2&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;4&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;4&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x13&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x3&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;5&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;5&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x14&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x4&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;6&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;6&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x15&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x5&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;7&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;7&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x16&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x6&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">index</span><span class="o">=</span><span class="s1">&#39;8&#39;</span> <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>&gt;
      &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;pcie-root-port&#39;</span>/&gt;
      &lt;target <span class="nv">chassis</span><span class="o">=</span><span class="s1">&#39;8&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0x17&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x7&#39;</span>/&gt;
    &lt;/controller&gt;
    &lt;interface <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;bridge&#39;</span>&gt;
      &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;52:54:00:e4:0c:13&#39;</span>/&gt;
      &lt;<span class="nb">source</span> <span class="nv">bridge</span><span class="o">=</span><span class="s1">&#39;virbr0&#39;</span>/&gt;
      &lt;model <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x01&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/interface&gt;
    &lt;interface <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;bridge&#39;</span>&gt;
      &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;52:54:00:d8:83:43&#39;</span>/&gt;
      &lt;<span class="nb">source</span> <span class="nv">bridge</span><span class="o">=</span><span class="s1">&#39;virbr2&#39;</span>/&gt;
      &lt;model <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x02&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/interface&gt;
    &lt;serial <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pty&#39;</span>&gt;
      &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;isa-serial&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>&gt;
        &lt;model <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;isa-serial&#39;</span>/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pty&#39;</span>&gt;
      &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;serial&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
    &lt;/console&gt;
    &lt;channel <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;unix&#39;</span>&gt;
      &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span> <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;org.qemu.guest_agent.0&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio-serial&#39;</span> <span class="nv">controller</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>/&gt;
    &lt;/channel&gt;
    &lt;channel <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;spicevmc&#39;</span>&gt;
      &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span> <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;com.redhat.spice.0&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio-serial&#39;</span> <span class="nv">controller</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;2&#39;</span>/&gt;
    &lt;/channel&gt;
    &lt;input <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;tablet&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>/&gt;
    &lt;/input&gt;
    &lt;input <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;mouse&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;ps2&#39;</span>/&gt;
    &lt;input <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;ps2&#39;</span>/&gt;
    &lt;graphics <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;spice&#39;</span> <span class="nv">autoport</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span>&gt;
      &lt;listen <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;address&#39;</span>/&gt;
      &lt;image <span class="nv">compression</span><span class="o">=</span><span class="s1">&#39;off&#39;</span>/&gt;
    &lt;/graphics&gt;
    &lt;sound <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;ich9&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x1b&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/sound&gt;
    &lt;video&gt;
      &lt;model <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;qxl&#39;</span> <span class="nv">ram</span><span class="o">=</span><span class="s1">&#39;65536&#39;</span> <span class="nv">vram</span><span class="o">=</span><span class="s1">&#39;65536&#39;</span> <span class="nv">vgamem</span><span class="o">=</span><span class="s1">&#39;16384&#39;</span> <span class="nv">heads</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="nv">primary</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span>/&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x01&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/video&gt;
    &lt;redirdev <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;spicevmc&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;2&#39;</span>/&gt;
    &lt;/redirdev&gt;
    &lt;redirdev <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;spicevmc&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;3&#39;</span>/&gt;
    &lt;/redirdev&gt;
    &lt;memballoon <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x06&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/memballoon&gt;
    &lt;rng <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span>&gt;
      &lt;backend <span class="nv">model</span><span class="o">=</span><span class="s1">&#39;random&#39;</span>&gt;/dev/urandom&lt;/backend&gt;
      &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;0x0000&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0x07&#39;</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">&#39;0x00&#39;</span> <span class="k">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span>/&gt;
    &lt;/rng&gt;
  &lt;/devices&gt;
&lt;/domain&gt;

</code></pre></div><ul>
<li>Comprobamos que se ha creado el fichero .qcow2 en el directorio <code>/var/lib/libvirt/images/</code></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# ls
buster-base.qcow2  compilar_default.img  debian-VAGRANTSLASH-buster64_vagrant_box_image_10.4.0.img
</code></pre></div><ul>
<li>Crea un par de claves ssh en formato ecdsa y sin frase de paso y agrega la clave pública al usuario debian</li>
</ul>
<p>Creamos el par de claves indicado</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">ssh-keygen -t ecdsa -b <span class="m">521</span>
</code></pre></div><p>En la mv creamos el fichero &lsquo;authorized_keys&rsquo;</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@debian-kvm:~/.ssh$ cat authorized_keys 
ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAF5SCIOXoPk1sXDH43L1r4YqoP15DHGxRfCvat01stXT0YEIeXujgFalyETMu3WqlIjLtca/b5JV4Gk//rk0IdfVQAXhQFgruXQ6e7EYSru0D9XCaTuiJ4oMzoFu/+caYUT+o5HeOSHTWj1EfOqqbJDsuACJ5vvjubPrQ54P6orN3D1dQ<span class="o">==</span> celiagm@debian
</code></pre></div><ul>
<li>Utiliza la herramienta virt-sparsify para reducir al máximo el tamaño de la imagen</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# virt-sparsify --compress buster-base.qcow2 buster-base_red.qcow2 
<span class="o">[</span>   0.0<span class="o">]</span> Create overlay file in /tmp to protect <span class="nb">source</span> disk
<span class="o">[</span>   0.0<span class="o">]</span> Examine <span class="nb">source</span> disk
 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ --:--
<span class="o">[</span>   7,1<span class="o">]</span> Fill free space in /dev/sda1 with zero
<span class="o">[</span>   8,7<span class="o">]</span> Copy to destination and make sparse
<span class="o">[</span>  64,8<span class="o">]</span> Sparsify operation completed with no errors.
virt-sparsify: Before deleting the old disk, carefully check that the 
target disk boots and works correctly.

</code></pre></div><ul>
<li>Comprobamos que está creada la imagen y ocupa menos espacio</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# ls -lh
total 5,8G
-rw------- <span class="m">1</span> root         root         3,1G mar <span class="m">22</span> 17:38 buster-base.qcow2
-rw-r--r-- <span class="m">1</span> root         root         377M mar <span class="m">22</span> 17:46 buster-base_red.qcow2

</code></pre></div><ul>
<li>Sube la imagen y la clave privada ssh a alguna ubicación pública desde la que se pueda descargar (lo subimos a mega)</li>
</ul>
<hr>
<p>Escribe un shell script que ejecutado por un usuario con acceso a qemu:///system realice los siguientes pasos:</p>
<ol>
<li>Crea una imagen nueva, que utilice buster-base.qcow2 como imagen base y tenga 5 GiB de tamaño máximo. Esta imagen se denominará maquina1.qcow2</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">qemu-img create -f qcow2 -b buster-base_red.qcow2 maquina1.qcow2 5G
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# qemu-img create -f qcow2 -b buster-base_red.qcow2 maquina1.qcow2 5G
Formatting <span class="s1">&#39;maquina1.qcow2&#39;</span>, <span class="nv">fmt</span><span class="o">=</span>qcow2 <span class="nv">size</span><span class="o">=</span><span class="m">5368709120</span> <span class="nv">backing_file</span><span class="o">=</span>buster-base_red.qcow2 <span class="nv">cluster_size</span><span class="o">=</span><span class="m">65536</span> <span class="nv">lazy_refcounts</span><span class="o">=</span>off <span class="nv">refcount_bits</span><span class="o">=</span><span class="m">16</span>
</code></pre></div><p>Comprobamos que se ha creado</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# ls -lh
total 5,8G
-rw------- <span class="m">1</span> root         root         3,1G mar <span class="m">22</span> 17:38 buster-base.qcow2
-rw-r--r-- <span class="m">1</span> root         root         377M mar <span class="m">22</span> 17:46 buster-base_red.qcow2
-rw------- <span class="m">1</span> root         root         3,2G mar <span class="m">18</span> 17:51 compilar_default.img
-rwxr--r-- <span class="m">1</span> libvirt-qemu libvirt-qemu 1,1G ene <span class="m">27</span> 11:01 debian-VAGRANTSLASH-buster64_vagrant_box_image_10.4.0.img
-rw-r--r-- <span class="m">1</span> root         root         193K mar <span class="m">22</span> 18:18 maquina1.qcow2
</code></pre></div><ol start="2">
<li>Crea una red interna de nombre intra con salida al exterior mediante NAT que utilice el direccionamiento 10.10.20.0/24</li>
</ol>
<p>Creamos el nuevo fichero .xml.</p>
<p>Le proporcionamos un identificador y le proporcionamos una mac respetando los tres primeros octetos.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">cat /proc/sys/kernel/random/uuid 
</code></pre></div><p><code>intra.xml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;network&gt;
  &lt;name&gt;intra&lt;/name&gt;
  &lt;uuid&gt;697e03ff-85da-45ff-815b-b16170e2125f&lt;/uuid&gt;
  &lt;forward <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;nat&#39;</span>&gt;
    &lt;nat&gt;
      &lt;port <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;1024&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;65535&#39;</span>/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;virbr3&#39;</span> <span class="nv">stp</span><span class="o">=</span><span class="s1">&#39;on&#39;</span> <span class="nv">delay</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>/&gt;
  &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;52:54:00:a1:51:25&#39;</span>/&gt;
  &lt;ip <span class="nv">address</span><span class="o">=</span><span class="s1">&#39;10.10.20.0&#39;</span> <span class="nv">netmask</span><span class="o">=</span><span class="s1">&#39;255.255.255.0&#39;</span>&gt;
    &lt;dhcp&gt;
      &lt;range <span class="nv">start</span><span class="o">=</span><span class="s1">&#39;10.10.20.2&#39;</span> <span class="nv">end</span><span class="o">=</span><span class="s1">&#39;10.10.20.254&#39;</span>/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
</code></pre></div><p>La definimos, la iniciamos y comprobamos que esta activo</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu/networks# virsh net-define intra.xml 
Network intra defined from intra.xml

root@debian:/etc/libvirt/qemu/networks# virsh net-start intra
Network intra started

root@debian:/home/celiagm/isos# virsh net-autostart intra
Network intra marked as autostarted


root@debian:/home/celiagm/isos# virsh net-list --all
 Name              State      Autostart   Persistent
------------------------------------------------------
 default           active     yes         yes
 intra             active     yes         yes
 red2              active     yes         yes
 vagrant-libvirt   inactive   no          yes

</code></pre></div><ol start="3">
<li>Crea una máquina virtual (maquina1) conectada a la red intra, con 1 GiB de RAM, que utilice como disco raíz maquina1.qcow2 y que se inicie automáticamente. Arranca la máquina.</li>
</ol>
<p>Creamos el dominio, llamado maquina1.xml</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;domain <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;kvm&#34;</span>&gt;
  &lt;name&gt;dominio1&lt;/name&gt;
  &lt;memory <span class="nv">unit</span><span class="o">=</span><span class="s2">&#34;G&#34;</span>&gt;1&lt;/memory&gt;
  &lt;vcpu&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;<span class="nb">type</span> <span class="nv">arch</span><span class="o">=</span><span class="s2">&#34;x86_64&#34;</span>&gt;hvm&lt;/type&gt;
  &lt;/os&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/kvm&lt;/emulator&gt;
    &lt;disk <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span> <span class="nv">device</span><span class="o">=</span><span class="s1">&#39;disk&#39;</span>&gt;
      &lt;driver <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;qcow2&#39;</span>/&gt;
      &lt;<span class="nb">source</span> <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;/var/lib/libvirt/images/maquina1.qcow2&#39;</span>/&gt;
      &lt;target <span class="nv">dev</span><span class="o">=</span><span class="s1">&#39;vda&#39;</span>/&gt;
    &lt;/disk&gt;
    &lt;interface <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;network&#34;</span>&gt;
      &lt;<span class="nb">source</span> <span class="nv">network</span><span class="o">=</span><span class="s2">&#34;intra&#34;</span>/&gt;
      &lt;mac <span class="nv">address</span><span class="o">=</span><span class="s2">&#34;52:54:00:87:c1:a5&#34;</span>/&gt;
    &lt;/interface&gt;
    &lt;graphics <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;vnc&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;-1&#39;</span> <span class="nv">autoport</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span> <span class="nv">listen</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span> /&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre></div><p>Comprobamos que es válido el fichero xml</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu# virt-xml-validate maquina1.xml
maquina1.xml validates
</code></pre></div><p>Definimos y arrancamos la máquina</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu# virsh define maquina1.xml 
Domain maquina1 defined from maquina1.xml

root@debian:/etc/libvirt/qemu# virsh start maquina1
Domain maquina1 started
</code></pre></div><p>Vemos que está encendida</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/etc/libvirt/qemu# virsh list --all
 Id   Name               State
-----------------------------------
 <span class="m">3</span>    maquina1           running
 -    buster-base        shut off
 -    compilar_default   shut off

</code></pre></div><p>Nos conectamos a ella</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ virt-viewer -c qemu:///system maquina1
</code></pre></div><ol start="4">
<li>Crea un volumen adicional de 1 GiB de tamaño en formato RAW ubicado en el pool por defecto</li>
</ol>
<p>Creamos el volumen de 1Gb</p>
<p><code>vol.xml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&lt;volume <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span>&gt;
  &lt;name&gt;vol1.img&lt;/name&gt;
  &lt;key&gt;/var/lib/libvirt/images/vol1.img&lt;/key&gt;
  &lt;source&gt;
  &lt;/source&gt;
  &lt;allocation&gt;0&lt;/allocation&gt;
  &lt;capacity <span class="nv">unit</span><span class="o">=</span><span class="s2">&#34;G&#34;</span>&gt;1&lt;/capacity&gt;
  &lt;target&gt;
    &lt;path&gt;/var/lib/libvirt/images/vol1.img&lt;/path&gt;
    &lt;format <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span>/&gt;
  &lt;/target&gt;
&lt;/volume&gt;
</code></pre></div><p>Creamos el volumen en el pool por defecto</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# virsh vol-create default vol.xml 
Vol vol1.img created from vol.xml
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@debian:/var/lib/libvirt/images# virsh vol-list default
 Name                                                        Path
------------------------------------------------------------------------------------------------------------------------------------------------
 buster-base.qcow2                                           /var/lib/libvirt/images/buster-base.qcow2
 compilar_default.img                                        /var/lib/libvirt/images/compilar_default.img
 debian-VAGRANTSLASH-buster64_vagrant_box_image_10.4.0.img   /var/lib/libvirt/images/debian-VAGRANTSLASH-buster64_vagrant_box_image_10.4.0.img
 vol1.img                                                    /var/lib/libvirt/images/vol1.img
</code></pre></div><ol start="5">
<li>Una vez iniciada la MV maquina1, conecta el volumen a la máquina, crea un sistema de ficheros XFS en el volumen y móntalo en el directorio /var/lib/pgsql. Ten cuidado con los propietarios y grupos que pongas, para que funcione adecuadamente el siguiente punto.</li>
</ol>
</div>
        <div class="post-footer">
            <div class="info">
                
                
            </div>
        </div>

        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://1bit1nfo.netlify.app/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script></body>

</html>
